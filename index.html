<!DOCTYPE html><html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>NEON PULSE ¬∑ Infinity Run</title>
<style>
:root{--g1:#0f0c29;--g2:#302b63;--g3:#24243e;--glass:rgba(255,255,255,.08);--brd:rgba(255,255,255,.25);--neon:#7f5cff;--acc:#14ffe9;--ok:#33ffaa;--bad:#ff5577;--text:#e8ebff}
html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--g1),var(--g2),var(--g3));color:var(--text);overflow:hidden}
*{box-sizing:border-box}.glass{background:linear-gradient(to bottom,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--glass);border-radius:14px;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.35) inset,0 0 0 1px rgba(255,255,255,.05)}
.panel{padding:16px;margin:8px}.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;gap:12px}.grow{flex:1}.tiny{font-size:12px}.muted{opacity:.75}.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--glass);background:rgba(255,255,255,.06)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:12px;border:1px solid var(--brd);cursor:pointer;color:#eaf;user-select:none;box-shadow:0 0 0 1px rgba(255,255,255,.05) inset,0 4px 12px rgba(0,0,0,.2);background:rgba(255,255,255,.06);transition:transform .05s,box-shadow .2s}
.btn:hover{box-shadow:0 0 14px rgba(127,92,255,.35),0 4px 12px rgba(0,0,0,.25)}.btn:active{transform:translateY(1px)}.btn.neon{box-shadow:0 0 16px rgba(127,92,255,.6),0 0 32px rgba(20,255,233,.2) inset;border-color:rgba(255,255,255,.18)}
.btn.toggle.on{outline:2px solid var(--acc);box-shadow:0 0 16px rgba(20,255,233,.25),0 0 0 1px rgba(255,255,255,.1) inset}
.title{font-size:36px;font-weight:700;margin:10px 0 8px 0;text-align:center;text-shadow:0 0 12px rgba(127,92,255,.6)}
.subtitle{opacity:.85;text-align:center;margin-bottom:10px}.meta{opacity:.7;font-size:13px}
#root{position:relative;width:100%;height:100%}

/* Splash */
#splash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;transition:opacity .4s;z-index:50}
#splash .box{width:min(620px,92vw);padding:24px 28px;text-align:center}
#splash h1{margin:8px 0 4px 0;font-size:44px;letter-spacing:.6px;text-shadow:0 0 18px var(--neon)}
#splash .bar{height:8px;border-radius:8px;overflow:hidden;margin-top:12px;background:rgba(255,255,255,.1)}
#splash .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--neon));box-shadow:0 0 12px var(--acc),0 0 18px var(--neon) inset;transition:width .2s}

/* Sections */
section{position:absolute;inset:0;display:none;padding:24px;overflow:auto}section.show{display:block}

/* Menu, —Ü–µ–Ω—Ç—Ä + –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
#menu .hero{max-width:1100px;margin:0 auto;display:grid;gap:14px}
#menu .hero-top{display:grid;grid-template-columns:1fr;justify-items:center}
#menu .bigPlay{padding:22px 34px;font-size:26px;border-radius:18px;min-width:260px;box-shadow:0 0 24px rgba(127,92,255,.45),0 0 60px rgba(20,255,233,.15) inset}
#menu .row2{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:12px;max-width:900px;margin:8px auto 0}
.card{padding:14px;border-radius:12px;border:1px solid var(--glass);background:rgba(255,255,255,.05);box-shadow:0 8px 20px rgba(0,0,0,.25)}.card h3{margin:6px 0 10px 0}
#version{opacity:.6;font-size:12px;text-align:center;margin-top:10px}

/* Level Select */
#levelGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(164px,1fr));gap:12px;max-width:1200px;margin:0 auto}
.lvl{position:relative;padding:12px;border-radius:12px;border:1px solid var(--glass);background:rgba(255,255,255,.05);cursor:pointer}
.lvl .stars{color:#ffd65c}.lock{position:absolute;top:8px;right:8px;opacity:.85}
#myLevels{max-width:1200px;margin:18px auto 0}
.myItem{display:flex;gap:12px;align-items:center;justify-content:space-between;border:1px solid var(--glass);border-radius:12px;background:rgba(255,255,255,.05);padding:10px 12px}

/* Shop (–≤–∫–ª–∞–¥–∫–∏) */
#shopTabs{display:flex;gap:8px;margin:0 auto 10px;justify-content:center}.tabbtn{padding:10px 14px;border-radius:10px;border:1px solid var(--glass);background:rgba(255,255,255,.06);cursor:pointer}.tabbtn.active{outline:2px solid var(--acc)}
#shopGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;max-width:1200px;margin:0 auto}
.skin{display:flex;gap:12px;align-items:center;padding:12px;border:1px solid var(--glass);border-radius:12px;background:rgba(255,255,255,.05)}
.preview{width:56px;height:56px;border-radius:10px;border:1px solid var(--brd);box-shadow:0 0 12px rgba(20,255,233,.2) inset,0 0 10px rgba(127,92,255,.25)}

/* Editor */
#edWrap{display:flex;gap:12px;max-width:1200px;margin:0 auto}#edLeft{width:380px}
#edCanvas{flex:1;min-height:520px;height:64vh;border-radius:12px;border:1px solid var(--glass);background:rgba(3,6,12,.35);position:relative;overflow:hidden}
#edSurface{width:100%;height:100%;display:block}.toolrow{display:flex;gap:8px;flex-wrap:wrap}.toolrow .btn{min-width:90px}
.tag{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--glass);font-size:12px;background:rgba(255,255,255,.06)}

/* Game */
#game{position:relative;width:100%;height:100%}#gameCanvas{display:block;max-width:100%;width:100%;height:100%;background:#0b0d14;border:1px solid var(--glass);border-radius:12px}
#hud{position:absolute;inset:0;display:none;pointer-events:none}#hud .bar{position:absolute;top:16px;left:16px;right:16px;display:flex;justify-content:space-between;gap:8px}#hud .bar .btn{pointer-events:auto}
#countdown{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-size:120px;font-weight:800;text-shadow:0 0 22px var(--neon)}
#jumpBtn{position:absolute;bottom:22px;right:22px;display:none;padding:18px 26px;font-size:18px;border-radius:18px}.lefty #jumpBtn{left:22px;right:auto}@media (pointer:coarse){#jumpBtn{display:inline-flex}}
#toast{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}#toast .msg{min-width:220px;max-width:70vw;text-align:center;padding:12px 16px;border-radius:12px;border:1px solid var(--brd);background:rgba(0,0,0,.4);box-shadow:0 0 14px rgba(127,92,255,.35)}
</style>
</head><body><div id="root">

<!-- Splash -->
<div id="splash" class="glass"><div class="box panel">
  <h1>NEON PULSE</h1>
  <div class="subtitle"><span class="tag">QuickPlay Games</span> ¬∑ <span class="meta">Infinity Run</span></div>
  <div class="bar"><i id="splashBar"></i></div>
  <div class="mt8 tiny muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div></div>

<!-- MENU -->
<section id="menu"><div class="hero">
  <div class="hero-top">
    <div class="title">NEON PULSE</div>
    <div class="subtitle"><span class="meta">Infinity Run ¬∑ –°—Ç–∏–ª—å: QuickPlay ¬∑ –ù–µ–æ–Ω</span></div>
    <button id="btnPlay" class="btn neon bigPlay">–ò–≥—Ä–∞—Ç—å</button>
  </div>
  <div class="row2">
    <div class="card glass">
      <h3>–†–µ–¥–∞–∫—Ç–æ—Ä</h3><div class="tiny muted">–ë–∏–æ–º—ã, —Å–ø–∞–≤–Ω‚Äë–º–∞—Ä–∫–µ—Ä, –±—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.</div>
      <button id="btnEditor" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="card glass">
      <h3>–ú–∞–≥–∞–∑–∏–Ω</h3><div class="tiny muted">–°–∫–∏–Ω—ã –∏ FX (—Å–ª–µ–¥, –∏—Å–∫—Ä—ã, —Ä–∏–Ω–≥–∏).</div>
      <div class="mb8"><span class="pill"><span class="coin">‚¶ø</span> <span id="menuCoins">0</span></span></div>
      <button id="btnShop" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="card glass">
      <h3>–ö–≤–µ—Å—Ç—ã</h3><div class="tiny muted">–°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å –Ω–∞–≥—Ä–∞–¥–∞–º–∏.</div>
      <button id="btnQuests" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="card glass">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3><div class="tiny muted">–ó–≤—É–∫, –≤–∏–±—Ä–∞—Ü–∏—è, –ª–µ–≤—à–∞ –∏ –ø—Ä.</div>
      <button id="btnSettings" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  <div id="version" class="tiny muted">–í–µ—Ä—Å–∏—è: v1.5.0</div>
</div></section>

<!-- LEVEL SELECT -->
<section id="levelSelect">
  <div class="title">–í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è</div>
  <div class="row mb12">
    <button id="btnBackFromLevels" class="btn">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="pill"><span class="coin">‚¶ø</span> <span id="lsCoins">0</span></div>
    <div class="pill">–î–æ—Å—Ç—É–ø–Ω–æ: <b id="lsHighest">1</b></div>
  </div>
  <div id="levelGrid"></div>
  <div id="myLevels"></div>
</section>

<!-- SHOP -->
<section id="shop">
  <div class="title">–ú–∞–≥–∞–∑–∏–Ω</div>
  <div class="row mb12">
    <button id="btnBackFromShop" class="btn">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="pill"><span class="coin">‚¶ø</span> <span id="shopCoins">0</span></div>
  </div>
  <div id="shopTabs"><div id="tabSkins" class="tabbtn active">–°–∫–∏–Ω—ã</div><div id="tabEffects" class="tabbtn">–≠—Ñ—Ñ–µ–∫—Ç—ã</div></div>
  <div id="shopGrid"></div>
</section>

<!-- QUESTS -->
<section id="quests">
  <div class="title">–ö–≤–µ—Å—Ç—ã</div>
  <div class="row mb12"><button id="btnBackFromQuests" class="btn">‚Üê –ù–∞–∑–∞–¥</button></div>
  <div id="questsList" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));max-width:980px;margin:0 auto"></div>
</section>

<!-- SETTINGS -->
<section id="settings">
  <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  <div class="row mb12"><button id="btnBackFromSettings" class="btn">‚Üê –ù–∞–∑–∞–¥</button></div>
  <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));max-width:1100px;margin:0 auto">
    <div class="glass panel">
      <h3>–ê—É–¥–∏–æ</h3>
      <div class="mb8"><label><input id="setMute" type="checkbox"> –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å—ë</label></div>
      <div class="mb8"><label>–ú—É–∑—ã–∫–∞ <input id="setMusic" type="range" min="0" max="1" step="0.01"></label></div>
      <div class="mb8"><label>–≠—Ñ—Ñ–µ–∫—Ç—ã <input id="setSfx" type="range" min="0" max="1" step="0.01"></label></div>
    </div>
    <div class="glass panel">
      <h3>–ì–µ–π–º–ø–ª–µ–π</h3>
      <div class="mb8"><label><input id="setVibrate" type="checkbox"> –í–∏–±—Ä–∞—Ü–∏—è</label></div>
      <div class="mb8"><label><input id="setLefty" type="checkbox"> –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä—ã–∂–∫–∞</label></div>
      <div class="mb8"><label><input id="setFps" type="checkbox"> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å FPS</label></div>
      <div class="mb8"><label><input id="setAutoFs" type="checkbox"> –ê–≤—Ç–æ‚Äë–ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</label></div>
    </div>
    <div class="glass panel">
      <h3>–Ø–∑—ã–∫</h3>
      <div class="mb8"><select id="setLang"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option><option value="en">English</option></select></div>
      <div class="mt8"><button id="btnReset" class="btn danger">–°–±—Ä–æ—Å–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button></div>
    </div>
  </div>
</section>

<!-- EDITOR -->
<section id="editor">
  <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä —É—Ä–æ–≤–Ω–µ–π</div>
  <div id="edWrap">
    <div id="edLeft" class="glass panel">
      <div class="row mb8"><button id="edBack" class="btn">‚Üê –ù–∞–∑–∞–¥</button><button id="edTest" class="btn neon">–¢–µ—Å—Ç‚Äë–ø—É—Å–∫</button></div>
      <div class="row mb8"><button id="edSave" class="btn ok">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="edExport" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button><button id="edImport" class="btn">–ò–º–ø–æ—Ä—Ç</button><button id="edClear" class="btn danger">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
      <div class="mb8"><label>–ù–∞–∑–≤–∞–Ω–∏–µ <input id="edName" type="text" value="–ú–æ—è –∫–∞—Ä—Ç–∞"></label></div>
      <div class="mb8"><label>BPM <input id="edBpm" type="number" value="128" min="60" max="220"></label></div>
      <div class="mb8"><label>–°–∫–æ—Ä–æ—Å—Ç—å <input id="edSpeed" type="number" value="1.2" step="0.05" min="0.5" max="4"></label></div>
      <div class="mb8"><label>–ú–∏—Ä/–¢–µ–º–∞ <select id="edTheme"><option value="classic">Classic</option><option value="metal">Metal</option><option value="desert">Desert</option><option value="lunar">Lunar</option><option value="lava">Lava</option></select></label></div>
      <div class="mb8"><div class="toolrow">
        <button id="tool_platform" class="btn">platform</button><button id="tool_spike" class="btn">spike</button>
        <button id="tool_portalG" class="btn">portalG</button><button id="tool_portalS" class="btn">portalS</button><button id="tool_finish" class="btn">finish</button>
      </div></div>
      <div class="mb8"><div class="toolrow">
        <button id="tool_delete" class="btn toggle">–£–¥–∞–ª–∏—Ç—å</button><button id="tool_spawn" class="btn toggle">–°–ø–∞–≤–Ω</button>
        <button id="tool_spikeUp" class="btn toggle on">–®–∏–ø—ã ‚Üë</button>
      </div></div>
      <div class="tiny muted">
        <div><b>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</b> <span class="kbd">–õ–ö–ú</span> ‚Äî –≤—ã–±—Ä–∞—Ç—å/–ø–æ—Å—Ç–∞–≤–∏—Ç—å ¬∑ <span class="kbd">–ü–ö–ú/Shift</span> ‚Äî –ø–∞–Ω–æ—Ä–∞–º–∞ ¬∑ –ö–æ–ª—ë—Å–∏–∫–æ ‚Äî –∑—É–º ¬∑ <span class="kbd">Delete</span> ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</div>
        <div>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî 10 –∫–ª–µ—Ç–æ–∫ ¬∑ –°–µ—Ç–∫–∞/–ø—Ä–∏–≤—è–∑–∫–∞ ‚Äî –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª</div>
      </div>
    </div>
    <div id="edCanvas" class="glass"><canvas id="edSurface"></canvas></div>
  </div>
</section>

<!-- GAME -->
<section id="gameWrap"><div id="game">
  <canvas id="gameCanvas"></canvas>
  <div id="hud"><div class="bar">
    <div class="row"><button id="hudBack" class="btn">‚Üê –ù–∞–∑–∞–¥</button></div>
    <div class="row"><button id="hudPause" class="btn">–ü–∞—É–∑–∞</button><button id="hudFs" class="btn">FS</button></div>
  </div></div>
  <div id="countdown" class="glass">3</div><button id="jumpBtn" class="btn neon">JUMP</button>
</div></section>

<div id="toast"><div class="msg" style="display:none"></div></div>
</div>

<script>
(function(){ "use strict";
/* Utils */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s), on=(e,t,f)=>e&&e.addEventListener&&e.addEventListener(t,f,false);
const toast=(()=>{let box;return msg=>{box=box||$("#toast .msg");box.textContent=msg;box.style.display="block";box.style.opacity=1;clearTimeout(box._tm);box._tm=setTimeout(()=>{box.style.transition="opacity .4s";box.style.opacity=0;setTimeout(()=>{box.style.display="none";box.style.transition=""},420);},1400);}})();
const Store={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(_){return d}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(_){}}};

/* State */
const VERSION="v1.5.0";
const DefaultSettings={mute:false,music:0.7,sfx:0.8,lang:"ru",vibrate:true,lefty:false,showFps:false,autoFs:false,grid:true,snap:true,snapSize:24};
let Settings=Object.assign({},DefaultSettings,Store.get("np_settings",{}));
let Progress=Object.assign({highest:1,completed:[],coins:0,deaths:0,clears:0,totalCoinsEarned:0,noDeathFinishes:0},Store.get("np_progress",{}));
let Skins=Object.assign({owned:["solid_default"],equipped:"solid_default"},Store.get("np_skins",{}));
let Effects=Object.assign({owned:["fx_default"],equipped:"fx_default"},Store.get("np_fx",{}));
let Customs=Store.get("np_custom_levels",[]);
let Quests=Store.get("np_quests",{
  tasks:{
    q1:{name:"–ü—Ä–æ–π–¥–∏ 5 –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π",goal:5,progress:0,reward:500,claimed:false},
    q2:{name:"–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä–æ–≤–Ω—è 20",goal:20,progress:1,reward:800,claimed:false}, // progress=highest
    q3:{name:"–ó–∞—Ä–∞–±–æ—Ç–∞–π —Å—É–º–º–∞—Ä–Ω–æ 1000 –º–æ–Ω–µ—Ç",goal:1000,progress:0,reward:600,claimed:false},
    q4:{name:"–§–∏–Ω–∏—à –±–µ–∑ —Å–º–µ—Ä—Ç–µ–π √ó3",goal:3,progress:0,reward:1200,claimed:false}
  }
});
function saveAll(){Store.set("np_settings",Settings);Store.set("np_progress",Progress);Store.set("np_skins",Skins);Store.set("np_fx",Effects);Store.set("np_quests",Quests);Store.set("np_custom_levels",Customs);}

/* Worlds/Themes */
const WorldList=["classic","metal","desert","lunar","lava"];
const ThemeStyle={
 classic:{bgA:"#2a1e4a",bgB:"#0d1d28",platF:"rgba(232,235,255,.09)",platS:"rgba(232,235,255,.18)",spike:"#ff8896"},
 metal:{bgA:"#cfd6e2",bgB:"#7a8596",platF:"rgba(210,220,235,.12)",platS:"rgba(210,220,235,.36)",spike:"#ccd6e2"},
 desert:{bgA:"#87b5ff",bgB:"#ffdba8",platF:"rgba(255,225,180,.12)",platS:"rgba(255,225,180,.36)",spike:"#e0b56c"},
 lunar:{bgA:"#cfd3ff",bgB:"#5b5f89",platF:"rgba(200,208,230,.12)",platS:"rgba(200,208,230,.32)",spike:"#c7d0db"},
 lava:{bgA:"#1d0b0b",bgB:"#4a0b12",platF:"rgba(255,90,58,.14)",platS:"rgba(255,90,58,.40)",spike:"#ff4d3a"}
};

/* Scene & nav with hard stop */
let SCENE="none";
function hardStop(){try{Game.destroy()}catch(_){ } } // —Å—Ç–æ–ø –ª—É–ø–∞+–∑–≤—É–∫+–∏–Ω–ø—É—Ç
function show(id){
  ["menu","levelSelect","shop","quests","settings","editor","gameWrap"].forEach(s=>{const el=$("#"+s);el&&el.classList.remove("show")});
  const tgt=$("#"+id);tgt&&tgt.classList.add("show");
  document.body.classList.toggle("lefty",!!Settings.lefty);
  if(id!=="gameWrap") hardStop();
  // –ú—É–∑—ã–∫–∞: —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é; –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —Ç–∏—à–∏–Ω–∞ (–ø–æ —Ç–≤–æ–µ–º—É –∂–µ–ª–∞–Ω–∏—é)
  if(id==="menu") Audio.playMode("menu",92); else Audio.stop();
}
$("#version").textContent="–í–µ—Ä—Å–∏—è: "+VERSION;

/* Splash */
function startSplash(){const bar=$("#splashBar");let p=0;const iv=setInterval(()=>{p=Math.min(100,p+Math.random()*18+6);bar&&(bar.style.width=p+"%");if(p>=100){clearInterval(iv);hideSplash();}},180);setTimeout(hideSplash,2500)}
function hideSplash(){const sp=$("#splash");if(!sp)return;sp.style.opacity="0";setTimeout(()=>{sp.style.display="none";show("menu");updateMenu();},400)}
on(window,"load",()=>setTimeout(startSplash,300)); setTimeout(()=>{try{hideSplash()}catch(_){}} ,2600);

/* Menu buttons */
on($("#btnPlay"),"click",()=>{buildLevelGrid();show("levelSelect");});
on($("#btnEditor"),"click",()=>{Editor.open();});
on($("#btnShop"),"click",()=>{currentShopTab="skins";buildShop();show("shop");updateCoinsUI();});
on($("#btnQuests"),"click",()=>{buildQuests();show("quests");});
on($("#btnSettings"),"click",()=>{openSettings();show("settings");});
on($("#btnBackFromSettings"),"click",()=>show("menu"));
on($("#btnBackFromLevels"),"click",()=>show("menu"));
on($("#btnBackFromShop"),"click",()=>show("menu"));
on($("#btnBackFromQuests"),"click",()=>show("menu"));
function updateMenu(){$("#menuCoins").textContent=Progress.coins}
function updateCoinsUI(){$("#menuCoins").textContent=Progress.coins;$("#lsCoins").textContent=Progress.coins;$("#shopCoins").textContent=Progress.coins}

/* Levels (60 deterministic) */
function makeLevelMeta(){const arr=[];for(let id=1;id<=60;id++){const world=1+Math.floor((id-1)/12);const bpm=100+id*2;const speed=1+id*0.03;const difficulty=Math.min(10,Math.ceil(id*0.2));const theme=WorldList[(world-1)%WorldList.length];arr.push({id,name:"–£—Ä–æ–≤–µ–Ω—å "+id,world,bpm,speed,difficulty,theme});}return arr;}
const Levels=makeLevelMeta();
function buildLevelGrid(){
  const g=$("#levelGrid");g.innerHTML="";$("#lsHighest").textContent=Progress.highest;updateCoinsUI();
  for(const m of Levels){
    const d=document.createElement("div");d.className="lvl";d.id="lvl_"+m.id;const locked=m.id>Progress.highest;let stars="";for(let s=0;s<m.difficulty;s++)stars+="‚òÖ";
    d.innerHTML=`<div><b>#${m.id}</b> ¬∑ BPM ${m.bpm}</div><div class="tiny muted">–ú–∏—Ä ${m.world} ¬∑ ${m.theme}</div><div class="stars">${stars}</div>${locked?'<div class="tiny muted lock">üîí</div>':''}`;
    if(!locked)d.addEventListener("click",(()=>startLevel(m))); else d.addEventListener("click",()=>toast("–ó–∞–∫—Ä—ã—Ç–æ")); g.appendChild(d);
  }
  const my=$("#myLevels");my.innerHTML="";
  if(Customs?.length){
    const title=document.createElement("div");title.className="title";title.style.fontSize="22px";title.textContent="–ú–æ–∏ —É—Ä–æ–≤–Ω–∏";my.appendChild(title);
    Customs.forEach((it,idx)=>{const row=document.createElement("div");row.className="myItem";
      row.innerHTML=`<div><b>${it.name||("Custom "+(idx+1))}</b> ¬∑ BPM ${it.bpm||120} ¬∑ x${(it.speed||1.2).toFixed(2)} ¬∑ ${it.theme||'classic'}</div>
      <div class="row"><button class="btn neon">–ò–≥—Ä–∞—Ç—å</button><button class="btn danger">–£–¥–∞–ª–∏—Ç—å</button></div>`;
      const [bPlay,bDel]=row.querySelectorAll("button");
      bPlay.onclick=()=>{const meta={id:0,name:it.name||("Custom "+(idx+1)),bpm:+(it.bpm||120),speed:+(it.speed||1.2),difficulty:5,world:1,theme:it.theme||"classic",spawnX:it.spawnX||140};startLevel(meta,it.objs);};
      bDel.onclick=()=>{if(confirm("–£–¥–∞–ª–∏—Ç—å ¬´"+(it.name||("Custom "+(idx+1)))+"¬ª?")){Customs.splice(idx,1);saveAll();buildLevelGrid();}};
      my.appendChild(row);
    });
  }
}

/* Audio engine (menu only on menu; world music in game/test) */
const Audio=(()=>{let ctx,master,gMusic,gSfx,playing=false,timer=null,seqStep=0,mode="menu",bpm=96;
function ensure(){if(ctx)return;ctx=new (window.AudioContext||window.webkitAudioContext)();master=ctx.createGain();gMusic=ctx.createGain();gSfx=ctx.createGain();gMusic.connect(master);gSfx.connect(master);master.connect(ctx.destination);applyVol();}
function applyVol(){if(!master)return;master.gain.value=Settings.mute?0:1;gMusic.gain.value=Settings.music;gSfx.gain.value=Settings.sfx;}
function setVol(){applyVol()} function setBpm(v){bpm=Math.max(60,Math.min(220,v|0))} function setMode(m){mode=m;seqStep=0}
function env(t,peak,len){const g=ctx.createGain();g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(peak,t+0.01);g.gain.exponentialRampToValueAtTime(0.0001,t+len);return g;}
function osc(t,type,f,peak,len,group){const o=ctx.createOscillator();o.type=type;o.frequency.setValueAtTime(f,t);const g=env(t,peak,len);o.connect(g).connect(group||gMusic);o.start(t);o.stop(t+len);}
function noise(t,len,peak,group,dec){const sr=ctx.sampleRate||44100;const b=ctx.createBuffer(1,Math.floor(sr*len),sr),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/(dec||1100));const s=ctx.createBufferSource();s.buffer=b;const g=env(t,peak,len);s.connect(g).connect(group||gMusic);s.start(t);s.stop(t+len);}
function sfxJump(){if(!ctx)return;const t=ctx.currentTime;osc(t,"square",740,.22,.08,gSfx);osc(t+0.05,"square",880,.18,.06,gSfx);}
function sfxWin(){if(!ctx)return;const t=ctx.currentTime;osc(t,"triangle",392,.22,.16,gSfx);osc(t+0.08,"triangle",523,.22,.16,gSfx);osc(t+0.16,"triangle",659,.22,.2,gSfx);}
function sfxDeath(){if(!ctx)return;const t=ctx.currentTime;osc(t,"sawtooth",300,.22,.12,gSfx);osc(t+0.06,"sawtooth",220,.22,.12,gSfx);noise(t,.1,.18,gSfx,800);}
function patt_menu(n,spb){if(seqStep%4===0)osc(n,"sine",[220,277,330,277][(seqStep/4)%4|0],.15,spb*1.6);if(seqStep%8===6)noise(n+0.02,0.03,.06,null,1000);}
function patt_world1(n,spb){if(seqStep%4===0)osc(n,"sine",160,.5,0.12);if(seqStep%8===4)noise(n+0.02,0.06,.24,null,1500);if(seqStep%2===0)noise(n+0.01,0.02,.09,null,900);if(seqStep%8===0)osc(n+0.03,"triangle",[220,277,330,392][(seqStep/8)%4|0],.2,0.24);}
function patt_world2(n,spb){if(seqStep%4===0)osc(n,"sine",140,.55,0.12);if(seqStep%8===6)osc(n+0.02,"triangle",110,.3,0.12);if(seqStep%2===0)noise(n+0.005,0.02,.1,null,800);}
function patt_world3(n,spb){if(seqStep%4===2)noise(n,0.05,.28,null,1200);if(seqStep%2===0)noise(n+0.004,0.02,.08,null,650);if(seqStep%8===0)osc(n+0.04,"square",300,.18,0.18);}
function patt_world4(n,spb){if(seqStep%4===0)osc(n,"sawtooth",96,.45,0.16);if(seqStep%8===4)noise(n+0.02,0.06,.24,null,1400);}
function patt_world5(n,spb){if(seqStep%8===0)osc(n,"sine",[196,247,294,370][(seqStep/8)%4|0],.22,spb*1.4);if(seqStep%2===0)noise(n+0.005,0.02,.08,null,900);}
function schedule(){if(!ctx||Settings.mute||!playing)return;const now=ctx.currentTime,spb=60/bpm;for(let i=0;i<2;i++){const t=now+i*(spb/4);({menu:patt_menu,world1:patt_world1,world2:patt_world2,world3:patt_world3,world4:patt_world4,world5:patt_world5}[mode]||patt_menu)(t,spb);seqStep++;}}
function loop(){if(timer)clearInterval(timer);timer=setInterval(()=>{try{schedule()}catch(_){}} ,100)}
function play(){ensure();if(ctx.state==='suspended')ctx.resume();playing=true;applyVol();loop();}
function stop(){if(!ctx){playing=false;return;}try{playing=false;const t=ctx.currentTime;const cur=master.gain.value;master.gain.cancelScheduledValues(t);master.gain.setValueAtTime(cur,t);master.gain.exponentialRampToValueAtTime(0.0001,t+0.12);if(timer){clearInterval(timer);timer=null;}setTimeout(()=>{applyVol();if(ctx&&ctx.state==='running'&&!playing)ctx.suspend();},160);}catch(_){playing=false;}}
function playMode(m,b){ensure();setMode(m);setBpm(b||96);play();}
function resume(){ensure();if(ctx.state==='suspended')ctx.resume();}
return {setVolumes:setVol,setBpm:setBpm,play:play,stop:stop,playMode:playMode,resume:resume,sfxJump:sfxJump,sfxWin:sfxWin,sfxDeath:sfxDeath};
})();
/* audio unlock */
(()=>{let ok=false;function u(){if(ok)return;ok=true;try{Audio.resume()}catch(_){ }["pointerdown","keydown","touchstart"].forEach(ev=>window.removeEventListener(ev,u,true));}["pointerdown","keydown","touchstart"].forEach(ev=>window.addEventListener(ev,u,true));})();

/* Shop: skins + effects */
const SkinCatalog=(()=>{const A=[];const Solid=(id,name,price,color,trail,glow)=>A.push({id,name,price,kind:'solid',color,trail:trail||'#14ffe9',glow:!!glow});
const Stripe=(id,name,price,a,b,glow)=>A.push({id,name,price,kind:'stripe',a,b,glow:!!glow});
const Grid=(id,name,price,a,b,glow)=>A.push({id,name,price,kind:'grid',a,b,glow:!!glow});
Solid('solid_default','–°—Ç–∞–Ω–¥–∞—Ä—Ç',0,'#e8ebff','#14ffe9',false);
Solid('solid_mint','–ú—è—Ç–∞',200,'#9fffd1','#33ffaa',false);
Solid('solid_amber','–Ø–Ω—Ç–∞—Ä—å',350,'#ffd65c','#ffb347',false);
Solid('solid_crimson','–ö—Ä–∏–º—Å–æ–Ω',500,'#ff4d6d','#ff99aa',false);
Solid('solid_ice','–õ—ë–¥',800,'#cfe9ff','#80e9ff',false);
Solid('solid_royal','–†–æ—è–ª',1200,'#7f5cff','#b79bff',true);
Solid('solid_violet','–§–∏–æ–ª–µ—Ç',1500,'#a57dff','#d0bfff',true);
Stripe('neon_core','–ù–µ–æ–Ω‚ÄëCore',3000,'#14ffe9','#0c2b2b',true);
Stripe('neon_ultra','–ù–µ–æ–Ω‚ÄëUltra',3500,'#7f5cff','#14102a',true);
Grid('steel_grid','–°—Ç–∞–ª—å–Ω–æ–π –≥—Ä–∏–¥',4000,'#b0b4c8','#1a1f27',false);
Grid('quantum_grid','–ö–≤–∞–Ω—Ç‚Äë–≥—Ä–∏–¥',6000,'#7f5cff','#0f0c20',true);
Grid('space_grid','–ö–æ—Å–º–æ‚Äë–≥—Ä–∏–¥',8000,'#59f1ff','#0a0f18',true);
Solid('inferno_legend','INFERNO',12000,'#ff6b00','#ffd000',true);
return A;})();
const EffectCatalog=(()=>{const E=[];const FX=(id,name,price,kind,opt={})=>E.push({id,name,price,kind,...opt});
FX('fx_default','–°—Ç–∞–Ω–¥–∞—Ä—Ç',0,'trail',{color:'#14ffe9',intensity:1});
FX('fx_neon','–ù–µ–æ–Ω–æ–≤—ã–π —Å–ª–µ–¥',1500,'trail',{color:'#7f5cff',intensity:1.4});
FX('fx_stars','–ó–≤—ë–∑–¥–Ω–∞—è –ø—ã–ª—å',3000,'spark',{color:'#e8ebff',intensity:1.2});
FX('fx_cyan_spark','–¶–∏–∞–Ω –∏—Å–∫—Ä—ã',3500,'spark',{color:'#14ffe9',intensity:1.5});
FX('fx_ring_pulse','–†–∏–Ω–≥–∏‚Äë–∏–º–ø—É–ª—å—Å—ã',4000,'ring',{color:'#7f5cff',intensity:1});
FX('fx_inferno','INFERNO FX',6000,'spark',{color:'#ff6b00',intensity:1.8});
return E;})();
let currentShopTab="skins";
function skinPreviewStyle(s){if(s.kind==='solid')return`background:${s.color};`;if(s.kind==='stripe')return`background:repeating-linear-gradient(45deg,${s.a},${s.a} 8px,${s.b} 8px,${s.b} 16px);`;if(s.kind==='grid')return`background:${s.b};background-image:linear-gradient(${s.a}22 1px,transparent 1px),linear-gradient(90deg,${s.a}22 1px,transparent 1px);background-size:12px 12px;`;return"";}
function buildShop(){
  $("#tabSkins").classList.toggle("active",currentShopTab==="skins");$("#tabEffects").classList.toggle("active",currentShopTab==="effects");
  const g=$("#shopGrid");g.innerHTML="";updateCoinsUI();
  if(currentShopTab==="skins"){
    for(const s of SkinCatalog){
      const owned=Skins.owned.includes(s.id),eq=(Skins.equipped===s.id);
      const right=owned?(eq?'<span class="ok">–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</span>':'<button class="btn">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>'):`<button class="btn">${s.price} ‚¶ø</button>`;
      const d=document.createElement("div");d.className="skin";
      d.innerHTML=`<div class="preview" style="${skinPreviewStyle(s)}"></div><div class="grow"><div><b>${s.name}</b>${s.glow?' <span class="tag" style="border-color:#7f5cff;background:#7f5cff15">glow</span>':''}${s.id==='inferno_legend'?' <span class="tag" style="border-color:#ff8a00;background:#ff8a0015">LEGEND</span>':''}</div><div class="tiny muted">${s.kind}</div></div><div>${right}</div>`;
      const btn=d.querySelector("button");if(btn)btn.onclick=()=>{if(!owned){if(Progress.coins>=s.price){Progress.coins-=s.price;Skins.owned.push(s.id);Skins.equipped=s.id;saveAll();buildShop();updateCoinsUI();toast("–ö—É–ø–ª–µ–Ω–æ");}else toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç");}else{Skins.equipped=s.id;saveAll();buildShop();toast("–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ");}};
      g.appendChild(d);
    }
  }else{
    for(const f of EffectCatalog){
      const owned=Effects.owned.includes(f.id),eq=(Effects.equipped===f.id);
      const right=owned?(eq?'<span class="ok">–í–∫–ª—é—á–µ–Ω–æ</span>':'<button class="btn">–í–∫–ª—é—á–∏—Ç—å</button>'):`<button class="btn">${f.price} ‚¶ø</button>`;
      const d=document.createElement("div");d.className="skin";
      d.innerHTML=`<div class="preview" style="background:radial-gradient(${(f.color||'#14ffe9')}55,transparent);"></div><div class="grow"><div><b>${f.name}</b> <span class="tag">FX</span></div><div class="tiny muted">${f.kind}</div></div><div>${right}</div>`;
      const btn=d.querySelector("button");if(btn)btn.onclick=()=>{if(!owned){if(Progress.coins>=f.price){Progress.coins-=f.price;Effects.owned.push(f.id);Effects.equipped=f.id;saveAll();buildShop();updateCoinsUI();toast("–ö—É–ø–ª–µ–Ω–æ");}else toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç");}else{Effects.equipped=f.id;saveAll();buildShop();toast("–í–∫–ª—é—á–µ–Ω–æ");}};
      g.appendChild(d);
    }
  }
}
on($("#tabSkins"),"click",()=>{currentShopTab="skins";buildShop();});
on($("#tabEffects"),"click",()=>{currentShopTab="effects";buildShop();});

/* Quests */
function buildQuests(){
  const q=$("#questsList");q.innerHTML="";
  // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á
  Quests.tasks.q1.progress = Math.min(Quests.tasks.q1.goal, Progress.clears); // –æ—Ñ. –∫–ª–∏—Ä—ã
  Quests.tasks.q2.progress = Math.min(Quests.tasks.q2.goal, Progress.highest);
  Quests.tasks.q3.progress = Math.min(Quests.tasks.q3.goal, Progress.totalCoinsEarned);
  Quests.tasks.q4.progress = Math.min(Quests.tasks.q4.goal, Progress.noDeathFinishes);

  for(const [id,t] of Object.entries(Quests.tasks)){
    const done=t.progress>=t.goal, claimable=done&&!t.claimed;
    const d=document.createElement("div");d.className="glass panel";
    d.innerHTML=`<div class="row"><div class="grow"><b>${t.name}</b><div class="tiny muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${t.progress}/${t.goal}</div></div><div>${t.claimed?'<span class="ok">–ó–∞–±—Ä–∞–Ω–æ</span>':(claimable?`<button class="btn">–ó–∞–±—Ä–∞—Ç—å ${t.reward} ‚¶ø</button>`:`<span class="tiny muted">${t.reward} ‚¶ø</span>`)}</div></div>`;
    const btn=d.querySelector("button");
    if(btn) btn.onclick=()=>{Progress.coins+=t.reward; t.claimed=true; saveAll(); buildQuests(); updateCoinsUI(); toast("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞");};
    q.appendChild(d);
  }
}

/* Deterministic RNG for levels */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5; t=Math.imul(t ^ (t>>>15), t | 1); t^=t + Math.imul(t ^ (t>>>7), t | 61); return ((t ^ (t>>>14))>>>0)/4294967296;}}
function rngForLevel(meta){let seed = 0xDEC0AD ^ (meta.id||1)*9973 ^ 0x9E3779B9; return mulberry32(seed>>>0);}

/* Level generator (deterministic + safe start + denser second half) */
function baseLevelData(meta){
  const R=rngForLevel(meta); const P=[],S=[],O=[],F=[];
  const length=7200+meta.difficulty*1000, groundY=300, gH=24;
  const spdBase=260*meta.speed, safeSec=2, safeEndX=Math.floor((meta.spawnX||140)+spdBase*safeSec+140);
  P.push({x:0,y:groundY,w:length,h:gH});
  const startX=Math.max(safeEndX,540);
  let x=startX;
  while(x<length-900){
    const t=(x-startX)/(length-startX);
    const stepBase=240+R()*220;
    let step=stepBase*(1-0.15*t);
    step=Math.max(160,step);
    if(R()<0.22){ for(let c=0;c<3;c++){pushObj(x+Math.floor(c*Math.max(80,step*0.6)));} x+=step*3; }
    else { pushObj(x); x+=step; }
  }
  function pushObj(xx){
    if(R()<0.5){
      const w=130+Math.floor(R()*160), y=(groundY-(60+R()*100))|0;
      P.push({x:xx,y,w,h:18});
      if(R()<0.35) S.push({x:xx+Math.floor(w/2)-12,y:groundY,dir:'up'});
    }else{
      S.push({x:xx,y:groundY,dir:'up'}); S.push({x:xx+24,y:groundY,dir:'up'});
    }
  }
  const px=startX+360;
  O.push({x:px,y:groundY-24,kind:'gravity',value:-1});
  O.push({x:px+720,y:groundY-24,kind:'gravity',value:1});
  O.push({x:px+1440,y:groundY-24,kind:'speed',value:1.4});
  if(meta.difficulty>=6) O.push({x:px+2300,y:groundY-24,kind:'speed',value:0.8});
  F.push({x:length-60,y:groundY-120,h:120});
  return {objs:{platform:P,spike:S,portal:O,finish:F},safeEndX};
}

/* Game */
const Game=(()=>{const canvas=$("#gameCanvas"),ctx=canvas.getContext("2d");let W=0,H=0,DPR=1,raf=0;
let running=false,paused=false,meta=null,world=null,scroll=0,spd=260,safeEndX=0,grav=2200,gravDir=1;
const player={sx:140,y:220,w:30,h:30,vy:0,on:false};
let last=0,acc=0,fix=1/120,particles=[],portalFx=0,lfps=0,fps=0,lfpst=0,runDeaths=0,attemptFx=0,shake=0;

function resize(){DPR=window.devicePixelRatio||1;const r=canvas.getBoundingClientRect();W=Math.max(1,r.width|0);H=Math.max(1,r.height|0);canvas.width=W*DPR;canvas.height=H*DPR;ctx.setTransform(DPR,0,0,DPR,0,0);}
const aabb=(ax,ay,aw,ah,b)=>ax<b.x+b.w && ax+aw>b.x && ay<b.y+b.h && ay+ah>b.y; const triBBox=s=>({x:s.x,y:(s.dir==='up'?s.y-12:s.y),w:24,h:12});
const curSkin=()=>SkinCatalog.find(s=>s.id===Skins.equipped)||{kind:'solid',color:'#e8ebff',trail:'#14ffe9',glow:false};
const curFX=()=>EffectCatalog.find(f=>f.id===Effects.equipped)||{id:'fx_default',kind:'trail',color:'#14ffe9',intensity:1};

function init(m,custom){
  SCENE="game"; meta=m; gravDir=1; scroll=0; spd=260*m.speed; runDeaths=0; attemptFx=1; shake=0;
  const gen=baseLevelData(m); world=(custom||gen.objs); safeEndX=gen.safeEndX||0;
  particles.length=0; portalFx=0; player.y=200; player.vy=0; player.on=false;
  running=true; paused=false; last=0; acc=0;
  const mode = {"classic":"world1","metal":"world2","desert":"world3","lunar":"world4","lava":"world5"}[m.theme] || "world1";
  Audio.playMode(mode,m.bpm||120);
  $("#hud").style.display='block';
  bind(); resize(); raf=requestAnimationFrame(loop);
}
function stop(){running=false;$("#hud").style.display='none';}
function destroy(){try{stop()}catch(_){ } try{unbind()}catch(_){ } try{cancelAnimationFrame(raf)}catch(_){ } try{Audio.stop()}catch(_){ } SCENE="none";}
function bind(){document.addEventListener('keydown',handleKey);on(canvas,'pointerdown',ptrJump);on($("#jumpBtn"),'click',ptrJump);window.addEventListener('resize',resize);}
function unbind(){document.removeEventListener('keydown',handleKey);canvas.removeEventListener('pointerdown',ptrJump);$("#jumpBtn").removeEventListener('click',ptrJump);window.removeEventListener('resize',resize);}
function ptrJump(){if(SCENE!=='game')return;jump();Audio.resume();}

function loop(){if(!running)return;raf=requestAnimationFrame(loop);const now=performance.now();if(!last){last=now;return;}const dt=(now-last)/1000;last=now;if(now-lfpst>500){lfpst=now;lfps=fps;fps=0;}else fps++; if(paused){draw();return;} acc+=dt;while(acc>fix){step(fix);acc-=fix;} draw();}
function step(dt){
  if(shake>0) shake=Math.max(0,shake-0.04);
  scroll+=spd*dt; player.vy+=grav*gravDir*dt;
  const worldX=scroll+player.sx; let on=false;
  let nextY=player.y+player.vy*dt;
  const pBox={x:worldX,y:player.y,w:player.w,h:player.h}, pNext={x:worldX,y:nextY,w:player.w,h:player.h};
  for(const p of world.platform){ if(p.x>worldX+player.w+160||p.x+p.w<worldX-160)continue; if(aabb(pNext.x,pNext.y,pNext.w,pNext.h,p)){ if(gravDir>0&&player.vy>0&&(player.y+player.h)<=p.y+20){nextY=p.y-player.h;player.vy=0;on=true;} else if(gravDir<0&&player.vy<0&&(p.y+p.h)<=player.y+20){nextY=p.y+p.h;player.vy=0;on=true;} } }
  player.y=nextY; player.on=on;
  for(const spk of world.spike){ if(spk.x<=safeEndX)continue; if(spk.x>worldX+player.w+160||spk.x+24<worldX-160)continue; if(aabb(pBox.x,pBox.y,pBox.w,pBox.h,triBBox(spk))) return die(); }
  for(const po of world.portal){ if(po.x<=safeEndX)continue; const bb={x:po.x,y:po.y,w:24,h:24}; if(aabb(pBox.x,pBox.y,pBox.w,pBox.h,bb)){ if(po.kind==='gravity'){gravDir*=-1;portalFx=1;} else if(po.kind==='speed'){spd=260*meta.speed*(+po.value||1);portalFx=1;} if(meta.theme==='lava') shake=Math.min(1,shake+0.2); } }
  for(const fin of world.finish){const bb={x:fin.x,y:fin.y,w:18,h:fin.h}; if(aabb(pBox.x,pBox.y,pBox.w,pBox.h,bb)) return win(); }
  if(player.y>H+180||player.y<-200) return die();
  // passive FX
  const fx=curFX(); if(fx.kind==='spark' && Math.random()<0.6) particles.push({x:player.sx+Math.random()*player.w,y:player.y+(gravDir>0?player.h:0),vx:(Math.random()*60-30),vy:(Math.random()*-60-30)*gravDir,life:0.25,color:fx.color||'#14ffe9'});
}
function jump(){if(!running||paused) return; if(player.on){player.vy=-840*gravDir;spawnJumpFx();Audio.sfxJump(); if(Settings.vibrate&&navigator.vibrate)navigator.vibrate(10); if(meta.theme==='lava') shake=Math.min(1,shake+0.15);} }
function spawnJumpFx(){const s=curSkin(), fx=curFX(); if(fx.kind==='trail'){for(let i=0;i<12*fx.intensity;i++){particles.push({x:player.sx+(Math.random()*player.w),y:player.y+(gravDir>0?player.h:0),vx:(Math.random()*140-70),vy:(Math.random()*-90-40)*gravDir,life:0.4,color:fx.color||s.trail||'#14ffe9'});}}
else if(fx.kind==='spark'){for(let i=0;i<18*fx.intensity;i++){particles.push({x:player.sx+player.w/2,y:player.y+player.h/2,vx:(Math.random()*220-110),vy:(Math.random()*-160-40)*gravDir,life:0.35,color:fx.color||'#e8ebff'});}}
else if(fx.kind==='ring'){for(let a=0;a<360;a+=15){particles.push({x:player.sx+player.w/2,y:player.y+player.h/2,vx:Math.cos(a*Math.PI/180)*120,vy:Math.sin(a*Math.PI/180)*120,life:0.28,color:fx.color||'#7f5cff'});}}}
function die(){Progress.deaths++; runDeaths++; saveAll(); player.y=200; player.vy=0; gravDir=1; portalFx=0; particles.length=0; scroll=0; attemptFx=1; toast("–°–º–µ—Ä—Ç—å"); Audio.sfxDeath(); if(meta.theme==='lava') shake=0.5;}
function win(){
  let reward=12+meta.difficulty*3;
  if(!meta.id){ // –∫–∞—Å—Ç–æ–º ‚Äî –±–µ–∑ –º–æ–Ω–µ—Ç
    reward=0;
  }
  // –º–æ–Ω–µ—Ç—ã/–ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –æ—Ñ–∏—Ü–∏–∞–ª–∫—É
  if(reward>0){Progress.coins+=reward; Progress.totalCoinsEarned+=reward;}
  // –∫–≤–µ—Å—Ç—ã (–æ—Ñ–∏—Ü–∏–∞–ª–∫–∏): q1 ‚Äî clears, q4 ‚Äî no-death
  if(meta.id){Progress.clears++; if(runDeaths===0) Progress.noDeathFinishes++; if(meta.id>=Progress.highest) Progress.highest=Math.min(60,meta.id+1); if(!Progress.completed.includes(meta.id)) Progress.completed.push(meta.id);}
  saveAll();
  toast(reward?("–§–∏–Ω–∏—à +"+reward+" ‚¶ø"):"–§–∏–Ω–∏—à (–∫–∞—Å—Ç–æ–º)");
  Audio.sfxWin();
  setTimeout(()=>{show("levelSelect");buildLevelGrid();},650);
}

function bgDecor(ctx,W,H,t,theme){
  if(theme==='desert'){ // –ø–µ—Å–æ–∫ + –Ω–µ–±–æ
    const sky=ctx.createLinearGradient(0,0,0,H*0.55); sky.addColorStop(0,"#87b5ff"); sky.addColorStop(1,"#ffdba8");
    ctx.save();ctx.globalAlpha=.8;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H*0.55);ctx.restore();
    ctx.save();ctx.globalAlpha=.18;ctx.fillStyle='#ffcf9a';for(let i=0;i<3;i++){const y=H*0.62+i*18;ctx.beginPath();ctx.moveTo(0,y);for(let x=0;x<=W;x+=24){ctx.lineTo(x,y+Math.sin((x*0.01)+t*0.6+i)*6);}ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();}ctx.restore();
  }else if(theme==='metal'){ // –±–ª–µ—Å–∫ –¥–∏–∞–≥–æ–Ω–∞–ª–µ–π
    const sky=ctx.createLinearGradient(0,0,W,0); sky.addColorStop(0,"#dce4f0"); sky.addColorStop(1,"#9aa6b8");
    ctx.save();ctx.globalAlpha=.6;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();
    ctx.save();ctx.globalAlpha=.18;ctx.strokeStyle='#eaf1ff';for(let x=-W;x<W*2;x+=26){ctx.beginPath();ctx.moveTo(x+((t*40)%26),0);ctx.lineTo(x+((t*40)%26)+W,H);ctx.stroke();}ctx.restore();
  }else if(theme==='lunar'){ // ¬´–ª—É–Ω–Ω—ã–µ¬ª –∫—Ä–∞—Ç–µ—Ä—ã
    const sky=ctx.createLinearGradient(0,0,0,H); sky.addColorStop(0,"#cfd3ff"); sky.addColorStop(1,"#5b5f89");
    ctx.save();ctx.globalAlpha=.7;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();
    ctx.save();ctx.globalAlpha=.18;ctx.fillStyle='#c7d0db66';for(let i=0;i<8;i++){ctx.beginPath();ctx.arc((i*W/8+ (i%2?30:-30) + (Math.sin(t+i)*20))%W, (H*0.5+ (i%3)*24), 8+((i*7)%10),0,Math.PI*2);ctx.fill();}ctx.restore();
  }else if(theme==='lava'){ // –æ–±—ä—ë–º–Ω–∞—è –ª–∞–≤–∞ + glow + —Å–ª–µ–≥–∫–∞ —Ç—Ä—è—Å—ë–º
    ctx.save();ctx.globalAlpha=.25;for(let i=0;i<6;i++){const x=((i*W/6)+((t*60)%W));const grd=ctx.createLinearGradient(x,0,x+60,0);grd.addColorStop(0,'#ff5a00');grd.addColorStop(1,'#ff1444');ctx.fillStyle=grd;ctx.fillRect((x%W)-60,0,60,H);}ctx.restore();
    ctx.save();ctx.globalAlpha=.1;ctx.fillStyle='#ff7a00';for(let y=0;y<H;y+=32){ctx.fillRect(0,y+Math.sin((y*0.05)+t*2)*4,W,16);}ctx.restore();
  }else{ // classic ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≥—Ä–∏–¥ –Ω–∞ –º—è–≥–∫–æ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–µ
    const sky=ctx.createLinearGradient(0,0,W,0); sky.addColorStop(0,"#2a1e4a"); sky.addColorStop(1,"#0d1d28");
    ctx.save();ctx.globalAlpha=.9;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();
    ctx.save();ctx.globalAlpha=.12;ctx.strokeStyle='#7f5cff55';for(let y=20;y<H;y+=24){ctx.beginPath();ctx.moveTo(0,y+Math.sin((y*0.06)+t*1.0)*6);ctx.lineTo(W,y+Math.sin((y*0.06)+t*1.0)*6);ctx.stroke();}ctx.restore();
  }
}
function draw(){
  const st=ThemeStyle[meta?.theme||"classic"]; const t=performance.now()/1000;
  let shakeX=0,shakeY=0; if(meta.theme==='lava' && shake>0){shakeX=(Math.random()*2-1)*6*shake;shakeY=(Math.random()*2-1)*4*shake;}
  ctx.save();ctx.translate(shakeX,shakeY);
  // bg
  ctx.clearRect(-10,-10,W+20,H+20);
  bgDecor(ctx,W,H,t,meta.theme);

  // world
  ctx.save();ctx.translate(-scroll,0);
  ctx.strokeStyle=st.platS;ctx.fillStyle=st.platF;
  for(const p of world.platform){ctx.fillRect(p.x,p.y,p.w,p.h);ctx.strokeRect(p.x,p.y,p.w,p.h);}
  ctx.fillStyle=st.spike;
  for(const s of world.spike){ctx.beginPath();if(s.dir==='up'){ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+12,s.y-12);ctx.lineTo(s.x+24,s.y);} else {ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+12,s.y+12);ctx.lineTo(s.x+24,s.y);} ctx.closePath();ctx.fill();}
  for(const po of world.portal){ctx.strokeStyle=(po.kind==='gravity')?'#7f5cff':'#14ffe9';ctx.lineWidth=2;ctx.strokeRect(po.x,po.y,24,24);}
  for(const fin of world.finish){const grd=ctx.createLinearGradient(fin.x,0,fin.x+18,0);grd.addColorStop(0,'#14ffe9');grd.addColorStop(1,'#7f5cff');ctx.fillStyle=grd;ctx.fillRect(fin.x,fin.y,18,fin.h);}
  ctx.restore();

  // player + glow
  const s=curSkin(); if(s.glow||s.id==='inferno_legend'){ctx.save();ctx.shadowColor=(s.id==='inferno_legend'?'#ff6b00':(s.trail||'#14ffe9'));ctx.shadowBlur=18;}
  if(s.kind==='solid'){ctx.fillStyle=s.color;ctx.fillRect(player.sx,player.y,player.w,player.h);}
  else if(s.kind==='stripe'){ctx.save();ctx.fillStyle=(s.a||'#14ffe9');ctx.fillRect(player.sx,player.y,player.w,player.h);ctx.globalCompositeOperation='source-atop';ctx.fillStyle=(s.b||'#0c2b2b');for(let ix=0;ix<player.w;ix+=6)ctx.fillRect(player.sx+ix,player.y,3,player.h);ctx.restore();}
  else{ctx.save();ctx.fillStyle=(s.b||'#0e0e19');ctx.fillRect(player.sx,player.y,player.w,player.h);ctx.globalCompositeOperation='source-atop';ctx.strokeStyle=((s.a||'#7f5cff')+'88');for(let gx=0;gx<=player.w;gx+=6){ctx.beginPath();ctx.moveTo(player.sx+gx,player.y);ctx.lineTo(player.sx+gx,player.y+player.h);ctx.stroke();}ctx.restore();}
  if(s.glow||s.id==='inferno_legend')ctx.restore();

  // particles
  const next=[]; for(const pr of particles){pr.life-=1/60;if(pr.life>0){pr.x+=pr.vx/60;pr.y+=pr.vy/60;ctx.globalAlpha=Math.max(0,pr.life*2);ctx.fillStyle=pr.color;ctx.fillRect(pr.x-2,pr.y-2,4,4);ctx.globalAlpha=1;next.push(pr);}} particles=next;

  // Attempt
  if(attemptFx>0){attemptFx=Math.max(0,attemptFx-0.02);ctx.save();ctx.globalAlpha=attemptFx;ctx.fillStyle='#e8ebff';ctx.font='16px system-ui';ctx.fillText('Attempt '+(runDeaths+1), player.sx-6, Math.max(20,player.y-10));ctx.restore();}
  // HUD
  ctx.fillStyle='#e8ebff'; ctx.font='14px system-ui'; if(meta) ctx.fillText('BPM '+meta.bpm+'   SPEED '+meta.speed.toFixed(2), 10, 18); if(Settings.showFps) ctx.fillText('FPS '+lfps, 10, 36);
  if(portalFx>0){portalFx-=0.04;ctx.save();ctx.globalAlpha=portalFx*0.6;ctx.strokeStyle='#14ffe9';ctx.lineWidth=6;ctx.strokeRect(6,6,W-12,H-12);ctx.restore();}
  ctx.restore(); // shake end
}
function togglePause(){if(!running)return;paused=!paused;toast(paused?"–ü–∞—É–∑–∞":"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å");}
function handleKey(e){if(SCENE!=='game')return;if(e.code==='Space'){e.preventDefault();jump();} if(e.code==='Escape'){togglePause();}}
function goFs(){const el=document.documentElement;const r=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;if(r)r.call(el);}
return {init,stop,destroy,goFs};
})();

/* Start level (countdown off for speed ‚Äî –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) */
function startLevel(meta,customObjs){show("gameWrap"); Game.init(meta,customObjs); requestAnimationFrame(()=>{try{Game.resize&&Game.resize()}catch(_){}}); if(Settings.autoFs)setTimeout(()=>{try{Game.goFs()}catch(_){}} ,120);
$("#hudPause").onclick=()=>{Game.togglePause&&Game.togglePause();}; $("#hudFs").onclick=()=>Game.goFs&&Game.goFs(); $("#hudBack").onclick=()=>show("menu");}

/* Settings */
function openSettings(){show("settings");$("#setMute").checked=!!Settings.mute;$("#setMusic").value=Settings.music;$("#setSfx").value=Settings.sfx;$("#setVibrate").checked=!!Settings.vibrate;$("#setLefty").checked=!!Settings.lefty;$("#setFps").checked=!!Settings.showFps;$("#setAutoFs").checked=!!Settings.autoFs;$("#setLang").value=Settings.lang;}
on($("#setMute"),"change",function(){Settings.mute=this.checked;saveAll();Audio.setVolumes();if(Settings.mute)Audio.stop();});
on($("#setMusic"),"input",function(){Settings.music=parseFloat(this.value||"0");saveAll();Audio.setVolumes();});
on($("#setSfx"),"input",function(){Settings.sfx=parseFloat(this.value||"0");saveAll();Audio.setVolumes();});
on($("#setVibrate"),"change",function(){Settings.vibrate=this.checked;saveAll();});
on($("#setLefty"),"change",function(){Settings.lefty=this.checked;saveAll();document.body.classList.toggle("lefty",Settings.lefty);});
on($("#setFps"),"change",function(){Settings.showFps=this.checked;saveAll();});
on($("#setAutoFs"),"change",function(){Settings.autoFs=this.checked;saveAll();});
on($("#setLang"),"change",function(){Settings.lang=this.value;saveAll();updateCoinsUI();});
on($("#btnReset"),"click",function(){["np_settings","np_progress","np_skins","np_fx","np_quests","np_custom_levels"].forEach(localStorage.removeItem.bind(localStorage));location.reload();});

/* Editor */
const Editor=(()=>{const c=$("#edSurface"),wrap=$("#edCanvas"),ctx=c.getContext("2d");let W=0,H=0,DPR=1;
let cam={x:0,y:0,z:1},tool="platform",deleteMode=false,spawnMode=false,spikeUp=true;
let data={name:"–ú–æ—è –∫–∞—Ä—Ç–∞",bpm:128,speed:1.2,theme:"classic",spawnX:140,objs:{platform:[],spike:[],portal:[],finish:[]}};
let drag=null,dragType=null,dragOff={x:0,y:0},panning=false,px=0,py=0,selected=null,selectedType=null,bound=false,lastPlace=0;

function resize(){DPR=window.devicePixelRatio||1;const r=wrap.getBoundingClientRect();W=Math.max(1,r.width|0);H=Math.max(1,r.height|0);c.width=W*DPR;c.height=H*DPR;ctx.setTransform(DPR,0,0,DPR,0,0);draw();}
const toWorld=(mx,my)=>({x:(mx)/cam.z+cam.x,y:(my)/cam.z+cam.y}), snap=v=>Settings.snap?Math.round(v/Settings.snapSize)*Settings.snapSize:v;
function open(){hardStop();show("editor");resize();bind();$("#edName").value=data.name;$("#edBpm").value=data.bpm;$("#edSpeed").value=data.speed;$("#edTheme").value=data.theme;Audio.playMode("menu",90);draw();} // –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ ‚Äî –º—É–∑—ã–∫–∞ –º–µ–Ω—é

function bind(){if(bound)return;bound=true;
  on($("#edBack"),"click",()=>show("menu"));
  on($("#edTest"),"click",()=>{syncFields();const meta={id:0,name:data.name,bpm:data.bpm,speed:data.speed,difficulty:5,world:1,theme:data.theme,spawnX:data.spawnX};startLevel(meta,data.objs);});
  on($("#edSave"),"click",()=>{syncFields();Customs.push(JSON.parse(JSON.stringify(data)));saveAll();toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");});
  on($("#edExport"),"click",()=>{const j=JSON.stringify(data,null,2);const a=document.createElement('a');a.href='data:application/json;charset=utf-8,'+encodeURIComponent(j);a.download=(data.name||"level")+'.json';a.click();});
  on($("#edImport"),"click",()=>{const inp=document.createElement('input');inp.type='file';inp.accept='.json,application/json';inp.onchange=()=>{const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const obj=JSON.parse(r.result);if(obj?.objs?.platform&&obj.objs.spike&&obj.objs.portal&&obj.objs.finish){data=obj;$("#edName").value=data.name||"–ú–æ—è –∫–∞—Ä—Ç–∞";$("#edBpm").value=data.bpm||128;$("#edSpeed").value=data.speed||1.2;$("#edTheme").value=data.theme||"classic";toast("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ");draw();}else throw 0;}catch(_){toast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");}};r.readAsText(f);};inp.click();});
  on($("#edClear"),"click",()=>{data.objs={platform:[],spike:[],portal:[],finish:[]};selected=null;selectedType=null;draw();});
  on($("#edName"),"input",e=>data.name=e.target.value); on($("#edBpm"),"input",e=>{data.bpm=+e.target.value;}); on($("#edSpeed"),"input",e=>data.speed=+e.target.value);
  on($("#edTheme"),"change",e=>{data.theme=e.target.value;draw();});
  ["tool_platform","tool_spike","tool_portalG","tool_portalS","tool_finish"].forEach(id=>on($("#"+id),"click",()=>{tool=id.replace("tool_","");deleteMode=false;spawnMode=false;updateToggles();}));
  on($("#tool_delete"),"click",()=>{deleteMode=!deleteMode;spawnMode=false;updateToggles();});
  on($("#tool_spawn"),"click",()=>{spawnMode=!spawnMode;deleteMode=false;updateToggles();});
  on($("#tool_spikeUp"),"click",()=>{spikeUp=!spikeUp;$("#tool_spikeUp").classList.toggle("on",spikeUp);});
  ["mousedown","mousemove","mouseup","mouseleave","contextmenu","wheel"].forEach(ev=>c.addEventListener(ev,evCanvas));
  window.addEventListener('resize',resize); window.addEventListener('keydown',key); window.addEventListener('keyup',key);
}
function updateToggles(){$("#tool_delete").classList.toggle("on",deleteMode);$("#tool_spawn").classList.toggle("on",spawnMode);}
function syncFields(){data.name=$("#edName").value||"–ú–æ—è –∫–∞—Ä—Ç–∞";data.bpm=+($("#edBpm").value||"128");data.speed=+($("#edSpeed").value||"1.2");data.theme=$("#edTheme").value||"classic";}
function themeBg(ctx,W,H,t,theme){
  if(theme==='desert'){const sky=ctx.createLinearGradient(0,0,0,H);sky.addColorStop(0,"#87b5ff");sky.addColorStop(1,"#ffdba8");ctx.save();ctx.globalAlpha=.6;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();}
  else if(theme==='metal'){const sky=ctx.createLinearGradient(0,0,W,0);sky.addColorStop(0,"#dce4f0");sky.addColorStop(1,"#9aa6b8");ctx.save();ctx.globalAlpha=.5;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();}
  else if(theme==='lunar'){const sky=ctx.createLinearGradient(0,0,0,H);sky.addColorStop(0,"#cfd3ff");sky.addColorStop(1,"#5b5f89");ctx.save();ctx.globalAlpha=.6;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();}
  else if(theme==='lava'){ctx.save();ctx.globalAlpha=.4;ctx.fillStyle='#4a0b12';ctx.fillRect(0,0,W,H);ctx.restore();}
  else{const sky=ctx.createLinearGradient(0,0,W,0);sky.addColorStop(0,"#2a1e4a");sky.addColorStop(1,"#0d1d28");ctx.save();ctx.globalAlpha=.8;ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);ctx.restore();}
}
function draw(){
  ctx.clearRect(0,0,W,H); themeBg(ctx,W,H,performance.now()/1000,data.theme);
  // grid
  if(Settings.grid){ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=1;const step=Settings.snapSize;const startX=Math.floor(cam.x/step)*step-step*2,endX=cam.x+W/cam.z+step*2;ctx.save();ctx.scale(cam.z,cam.z);ctx.translate(-cam.x,-cam.y);
    for(let gx=startX;gx<endX;gx+=step){ctx.beginPath();ctx.moveTo(gx,cam.y-step*2);ctx.lineTo(gx,cam.y+H/cam.z+step*2);ctx.stroke();}
    const startY=Math.floor(cam.y/step)*step-step*2,endY=cam.y+H/cam.z+step*2;
    for(let gy=startY;gy<endY;gy+=step){ctx.beginPath();ctx.moveTo(cam.x-step*2,gy);ctx.lineTo(cam.x+W/cam.z+step*2,gy);ctx.stroke();}
    ctx.restore();
  }
  // objects
  ctx.save();ctx.scale(cam.z,cam.z);ctx.translate(-cam.x,-cam.y);
  ctx.fillStyle='rgba(255,255,255,.08)';ctx.strokeStyle='rgba(255,255,255,.2)';ctx.lineWidth=1;
  for(const p of data.objs.platform){ctx.fillRect(p.x,p.y,p.w,p.h);ctx.strokeRect(p.x,p.y,p.w,p.h);if(selected===p)hi(p.x,p.y,p.w,p.h);}
  ctx.fillStyle='#ff7788';
  for(const sp of data.objs.spike){ctx.beginPath();if(sp.dir==='up'){ctx.moveTo(sp.x,sp.y);ctx.lineTo(sp.x+12,sp.y-12);ctx.lineTo(sp.x+24,sp.y);} else {ctx.moveTo(sp.x,sp.y);ctx.lineTo(sp.x+12,sp.y+12);ctx.lineTo(sp.x+24,sp.y);} ctx.closePath();ctx.fill(); if(selected===sp){const bb={x:sp.x,y:(sp.dir==='up'?sp.y-12:sp.y),w:24,h:12};hi(bb.x,bb.y,bb.w,bb.h);} }
  for(const po of data.objs.portal){ctx.strokeStyle=(po.kind==='gravity')?'#7f5cff':'#14ffe9';ctx.lineWidth=2;ctx.strokeRect(po.x,po.y,24,24); if(selected===po)hi(po.x,po.y,24,24);}
  for(const fin of data.objs.finish){ctx.fillStyle='#14ffe9';ctx.fillRect(fin.x,fin.y,18,fin.h); if(selected===fin)hi(fin.x,fin.y,18,fin.h);}
  // spawn marker
  ctx.fillStyle='#e8ebff';ctx.globalAlpha=.95;ctx.beginPath();ctx.moveTo(data.spawnX,24);ctx.lineTo(data.spawnX-6,36);ctx.lineTo(data.spawnX+6,36);ctx.closePath();ctx.fill();ctx.globalAlpha=1;
  ctx.restore();
}
function hi(x,y,w,h){ctx.save();ctx.strokeStyle='rgba(255,255,255,.9)';ctx.setLineDash([6,4]);ctx.lineWidth=1.5;ctx.strokeRect(x-2,y-2,w+4,h+4);ctx.restore();}
function hit(wx,wy){for(const po of data.objs.portal){if(wx>=po.x&&wx<=po.x+24&&wy>=po.y&&wy<=po.y+24) return {obj:po,type:'portal'};}
  for(const sp of data.objs.spike){const bb={x:sp.x,y:(sp.dir==='up'?sp.y-12:sp.y),w:24,h:12}; if(wx>=bb.x&&wx<=bb.x+bb.w&&wy>=bb.y&&wy<=bb.y+bb.h) return {obj:sp,type:'spike'};}
  for(const f of data.objs.finish){if(wx>=f.x&&wx<=f.x+18&&wy>=f.y&&wy<=f.y+f.h) return {obj:f,type:'finish'};}
  for(const p of data.objs.platform){if(wx>=p.x&&wx<=p.x+p.w&&wy>=p.y&&wy<=p.y+p.h) return {obj:p,type:'platform'};} return {obj:null,type:null};}
function evCanvas(e){
  const r=c.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top; if(e.type==='contextmenu'){e.preventDefault();return;}
  if(e.type==='wheel'){const z0=cam.z;cam.z=Math.max(.4,Math.min(2.2,cam.z*(e.deltaY>0?.9:1.1)));const wx=cam.x+(mx/z0),wy=cam.y+(my/z0);cam.x=wx-(mx/cam.z);cam.y=wy-(my/cam.z);draw();return;}
  if(e.type==='mousedown'){
    if(e.button===2||e.buttons===4||e.shiftKey){panning=true;px=mx;py=my;return;}
    const w=toWorld(mx,my), h=hit(w.x,w.y);
    if(spawnMode){data.spawnX=snap(w.x); draw(); return;}
    if(deleteMode && h.obj){ removeObj(h); draw(); return; }
    if(h.obj){ selected=h.obj; selectedType=h.type; drag=h.obj; dragType=h.type; dragOff.x=w.x-(drag.x||0); dragOff.y=w.y-(drag.y||0); draw(); return; }
    // —Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—É—Å—Ç–æ–º –ø–æ–ª–µ (–∞–Ω—Ç–∏‚Äë–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)
    const now=performance.now(); if(now-lastPlace<140) return; lastPlace=now;
    const cell=Settings.snapSize||24, w10=cell*10;
    if(tool==='platform') data.objs.platform.push({x:snap(w.x-w10/2),y:snap(w.y-10),w:w10,h:18});
    if(tool==='spike') data.objs.spike.push({x:snap(w.x-12),y:snap(w.y),dir:(spikeUp?'up':'down')});
    if(tool==='portalG') data.objs.portal.push({x:snap(w.x-12),y:snap(w.y-12),kind:'gravity',value:-1});
    if(tool==='portalS') data.objs.portal.push({x:snap(w.x-12),y:snap(w.y-12),kind:'speed',value:1.4});
    if(tool==='finish') data.objs.finish.push({x:snap(w.x),y:0,h:320});
    draw();
  }
  if(e.type==='mousemove'){
    if(panning){cam.x-=(mx-px)/cam.z;cam.y-=(my-py)/cam.z;px=mx;py=my;draw();return;}
    if(!drag)return; const w=toWorld(mx,my);
    if(dragType==='platform'){drag.x=snap(w.x-dragOff.x);drag.y=snap(w.y-dragOff.y);}
    else if(dragType==='spike'||dragType==='portal'){drag.x=snap(w.x-12);drag.y=snap(w.y-(dragType==='spike'?0:12)); if(dragType==='spike'&&spikeUp) drag.dir='up';}
    else if(dragType==='finish'){drag.x=snap(w.x);}
    draw();
  }
  if(e.type==='mouseup'||e.type==='mouseleave'){panning=false;drag=null;dragType=null;}
}
function key(e){if(e.code==='Space') panning=(e.type==='keydown'); if(e.key==='Delete' && e.type==='keydown' && selected){ removeObj({obj:selected,type:selectedType}); selected=null; selectedType=null; draw(); } }
function removeObj(hit){const arr=data.objs[hit.type]; if(!arr)return; const i=arr.indexOf(hit.obj); if(i>=0) arr.splice(i,1);}
return {open};
})();

/* Boot */
updateMenu(); Audio.playMode("menu",92);
})();
</script>
</body></html>
